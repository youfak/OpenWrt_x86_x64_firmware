name: ç¼–è¯‘OpenWrtå›ºä»¶

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: 'è¦ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ (5.10.config/5.15.config)'
        required: true
        default: '5.10.config'
      ssh:
        description: 'æ˜¯å¦å¼€å¯SSHè°ƒè¯•'
        required: false
        default: 'false'
      upload_cowtransfer:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ°å¥¶ç‰›å¿«ä¼ '
        required: false
        default: 'false'
      upload_wetransfer:
        description: 'æ˜¯å¦ä¸Šä¼ åˆ°WeTransfer'
        required: false
        default: 'false'
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºReleaseå‘å¸ƒé¡µ'
        required: false
        default: 'true'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: ${{ github.event.inputs.upload_cowtransfer }}
  UPLOAD_WETRANSFER: ${{ github.event.inputs.upload_wetransfer }}
  UPLOAD_RELEASE: ${{ github.event.inputs.create_release }}
  TZ: Asia/Shanghai
  DIY_P1_SH: diy5.10.sh
  DIY_P2_SH: diy-part2.sh

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "FILE_TIME=$(date +"%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
      
      - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ (ä¼˜åŒ–å‰)
        run: |
          echo "ä¼˜åŒ–å‰çš„ç£ç›˜ç©ºé—´"
          echo "=================================================="
          df -hT
          echo "=================================================="
          
      - name: ç£ç›˜ç©ºé—´ä¼˜åŒ– (ç¬¬ä¸€é˜¶æ®µ)
        uses: hugoalh/disk-space-optimizer-ghaction@v0.8.1
        with:
          operate_sudo: "True"
          general_include: ".+"
          general_exclude: |-
            ^GCC$
            ^G\+\+$
            Clang
            LLVM
          docker_include: ".+"
          docker_prune: "True"
          docker_clean: "True"
          apt_prune: "True"
          apt_clean: "True"
          homebrew_prune: "True"
          homebrew_clean: "True"
          npm_prune: "True"
          npm_clean: "True"
          os_swap: "True"

      - name: ç£ç›˜ç©ºé—´ä¼˜åŒ– (ç¬¬äºŒé˜¶æ®µ)
        uses: easimon/maximize-build-space@master
        with: 
          root-reserve-mb: 2048
          swap-size-mb: 1
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´ (ä¼˜åŒ–å)
        run: |
          echo "ä¼˜åŒ–åçš„ç£ç›˜ç©ºé—´"
          echo "=================================================="
          df -hT
          echo "=================================================="
          
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev \
            file wget
          sudo apt install -y libelf-dev
          
      - name: ä¸‹è½½OpenWrtæºç 
        run: |
          git clone $REPO_URL openwrt
      
      - name: åŠ è½½è‡ªå®šä¹‰è®¾ç½®
        run: |
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH

      - name: æ›´æ–°è½¯ä»¶åŒ…
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      - name: æ›´æ”¹è®¾ç½®
        run: |
          [ -e files ] && mv files openwrt/files
          [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH
          
      - name: å¤åˆ¶è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
        run: |
          cp ${{ github.event.inputs.config_file }} openwrt/.config
          
      - name: è¿è¡ŒDIYè„šæœ¬
        run: |
          if [ "${{ github.event.inputs.config_file }}" = "5.10.config" ]; then
            cp diy5.10.sh openwrt/diy.sh
          elif [ "${{ github.event.inputs.config_file }}" = "5.15.config" ]; then
            cp diy5.15.sh openwrt/diy.sh
          fi
          cd openwrt
          chmod +x diy.sh
          ./diy.sh
          
      - name: é…ç½®ç¯å¢ƒå˜é‡ä»¥å¢åŠ ç¼–è¯‘å†…å­˜
        run: |
          echo "FORCE_UNSAFE_CONFIGURE=1" >> $GITHUB_ENV
          echo "=== è¿›ä¸€æ­¥ä¼˜åŒ–ç£ç›˜ç©ºé—´ ==="
          sudo -E swapoff -a
          sudo -E rm -f /swapfile
          sudo -E docker image prune -a -f
          sudo -E snap set system refresh.retain=2
          sudo -E apt-get -y purge azure* dotnet* firefox ghc* google* llvm* mono* mysql* openjdk* php* zulu*
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean
          sudo -E rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost
          
      - name: å¼€å¯SSHè¿æ¥ (å¦‚æœé€‰æ‹©)
        uses: mxschmitt/action-tmate@v3
        if: github.event.inputs.ssh == 'true'
        
      - name: ä¸‹è½½è½¯ä»¶åŒ…
        run: |
          cd openwrt
          make defconfig
          make download -j8
          
      - name: ç¼–è¯‘å›ºä»¶ (å°è¯•å¤šçº¿ç¨‹)
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘ä¸­..."
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: ç¼–è¯‘å›ºä»¶ (å•çº¿ç¨‹ - å¦‚æœå¤šçº¿ç¨‹å¤±è´¥)
        id: compile_fallback
        if: steps.compile.outputs.status != 'success'
        run: |
          cd openwrt
          echo -e "å•çº¿ç¨‹ç¼–è¯‘ä¸­..."
          make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          
      - name: ä¸Šä¼ binç›®å½•
        uses: actions/upload-artifact@main
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin_${{ github.event.inputs.config_file }}_${{ env.FILE_DATE }}
          path: openwrt/bin/packages/x86_64

      - name: æ•´ç†ç¼–è¯‘å¥½çš„å›ºä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages && mkdir packages
          find -name "*esxi-flat.vmdk*" | xargs -i mv -f {} packages
          find -name "*kernel.bin*" | xargs -i mv -f {} packages
          find -name "*rootfs*" | xargs -i mv -f {} packages
          find -name "*.manifest*" | xargs -i mv -f {} packages
          find -name "*vmlinuz*" | xargs -i mv -f {} packages
          find -name "*esxi.vmdk*" | xargs -i mv -f {} packages
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "å›ºä»¶å·²æ•´ç†å®Œæˆ:"
          ls -la

      - name: ä¸Šä¼ å›ºä»¶åˆ°github
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: OpenWrt_${{ github.event.inputs.config_file }}_${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¸Šä¼ å›ºä»¶åˆ°å¥¶ç‰›å¿«ä¼ 
        id: cowtransfer
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer cow --block 2621440 -s -p 64 --no-progress ${FIRMWARE} 2>&1 | tee cowtransfer.log
          echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
          echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å›ºä»¶åˆ°WeTransfer
        id: wetransfer
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
        run: |
          curl -fsSL git.io/file-transfer | sh
          ./transfer wet -s -p 16 --no-progress ${FIRMWARE} 2>&1 | tee wetransfer.log
          echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
          echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºreleaseå‘å¸ƒé¡µ
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "å›ºä»¶ä¿¡æ¯: OpenWrt ${{ github.event.inputs.config_file }} ç‰ˆæœ¬" >> release.txt
          echo "ç¼–è¯‘æ—¶é—´: ${{ env.FILE_TIME }}" >> release.txt
          echo "å›ºä»¶åŠŸèƒ½: æ”¯æŒIPv4/IPv6åŒæ ˆã€å¤šWANæ¥å…¥ã€iStoreåº”ç”¨å•†åº—ç­‰" >> release.txt
          echo "[å›ºä»¶æºç ](https://github.com/coolsnowwolf/lede)" >> release.txt
          echo "ç”±è¡·æ„Ÿè°¢æ‰€æœ‰ä¸ºOpenWrtæ— ç§å¥‰çŒ®çš„å¤§ä½¬ä»¬" >> release.txt
          echo "ğŸ“¥ å›ºä»¶ä¸‹è½½" >> release.txt
          [ $UPLOAD_COWTRANSFER = true ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
          [ $UPLOAD_WETRANSFER = true ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒè‡³Release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          name: ${{ env.FILE_TIME }} ã€Œ OpenWrt-${{ github.event.inputs.config_file }} ã€
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*

      - name: æ¸…ç†æ—§çš„workflow
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 0
          keep_minimum_runs: 2

      - name: åˆ é™¤æ—§çš„Releases
        uses: dev-drprasad/delete-older-releases@v0.1.0
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 20
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 